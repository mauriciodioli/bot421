{% extends 'layouts/layout_dpi.html' %}

{% block content %}
<div  id="navBarCaracteristicas-index" style="display: none;"></div>
<div class="splash-container" id="splash" style="display:none">
  {% include 'notificaciones/splashPage.html' %}
</div>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        {% with messages = get_flashed_messages() %}
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-warning alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

                 
      {% include 'ambitos/carrucelDominios.html' %}

   <!-- Banda azul brillante arriba -->  
            <div class="horizontal-padding vertical-padding" style="margin-top: 50px;">
  <div class="horizontal-padding vertical-padding">
    <section class="sobre-nosotros" id="sobre-nosotros">
      <div class="container" id="container-sobre-nosotros">
        <div class="flex-container">
          <div class="image-container-sobre-nosotros">
            <h1 class="sobre-nosotros"
                data-translate="dpi_title">
              <!-- i18n -->
            </h1>

            <h4 class="sobre-nosotros-descripcion"
                data-translate="dpi_description">
              <!-- i18n -->
            </h4>

            <form action="/dpi-in" method="GET">
              <button class="card-button long-button" style="margin-top: 20px;" type="submit"
                      data-translate="dpi_button">
                <!-- i18n -->
              </button>
            </form>
          </div>

          <div class="text-container-sobre-nosotros">
            <img src="/static/dpi.jpg"
                 data-translate="dpi_image_alt"
                 data-translate-target="alt"
                 alt="">
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- ===== Bloque ordenado y validado ===== -->
<div class="horizontal-padding vertical-padding">

  <!-- Cards -->
  <section class="stats" id="stats-card-resumen">
    <div class="card-container-grande">
      <div class="numRequeris-card1 card">
        <div class="card-content">
          <p class="card-title" data-translate="dpi_card_domains"></p>
          <p class="card-number">11</p>
        </div>
      </div>

      <div class="numRequeris-card2 card">
        <div class="card-content">
          <p class="card-title" data-translate="dpi_card_signals"></p>
          <p class="card-number">89</p>
        </div>
      </div>

      <div class="numRequeris-card3 card">
        <div class="card-content">
          <p class="card-title" data-translate="dpi_card_posts"></p>
          <p class="card-number">34</p>
        </div>
      </div>

      <div class="numRequeris-card4 card">
        <div class="card-content">
          <p class="card-title" data-translate="dpi_card_courses"></p>
          <p class="card-number">5</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Banner -->
  <div class="launch-banner">
    <h2 data-translate="dpi_banner_title"></h2>
    <p data-translate="dpi_banner_subtitle"></p>
    <a href="#domains-publicaciones" class="btn-discover" data-translate="dpi_banner_button"></a>
  </div>

  <!-- Lista de dominios (m√≥viles) -->
  <section class="domains" id="domains">
    <div class="card-container">
      <!-- Aqu√≠ se insertar√° los dominios para pantallas chicas -->
    </div>
  </section>

  <!-- Espaciador -->
  <div style="height: 20px;"></div>

  <!-- Publicaciones -->
  <section class="domains-publicaciones" id="domains-publicaciones">
    <div class="jumbotron">
      <h1 name="ambitoActual" id="ambitoActual" style="color: gold;" tabindex="0"></h1>

      {% include 'ambitos/navBarCaracteristicas.html' %}  <!-- Aqu√≠ se incluye la barra de navegaci√≥n -->

      <div class="splashCarga" id="splashNotificaciones" style="display: none;">
        <div class="splash-contenido">
          <div class="spinner"></div>
        </div>
      </div>

      <div class="dpi-muestra-publicaciones-centrales" tabindex="0">
        <!-- Aqu√≠ se insertar√° la galer√≠a -->
      </div>
    </div>
  </section>

</div>
<!-- /horizontal-padding vertical-padding -->


<!-- Contacto -->
<div class="horizontal-padding vertical-padding py-4">
  <section class="contacto" id="contacto">
    <div class="contactos-info">
      <h1 class="contactos-titulo" style="color: gold;" data-translate="dpi_contact_title">CONTACTO</h1>
      <h3 class="contactos-titulo" style="color: white;" data-translate="dpi_contact_subtitle">TE ASESORAMOS</h3>
      <form action="/llamada/index-contacto" method="GET">
        <button class="card-button long-button" style="margin-top: 20px;" type="submit" data-translate="dpi_contact_button">
          Habla con nosotros
        </button>
      </form>
    </div>
  </section>
</div>


<!-- Login -->
<div class="horizontal-padding vertical-padding py-4">
  <section class="ingreso" id="ingreso">
    <div class="ingreso-info">
      <h1 class="ingreso-titulo" style="color: gold;" data-translate="dpi_login_title">Iniciar sesi√≥n</h1>

      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <ul class="flashes">
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}

      <div class="form-container">
        <div class="row">

          {% with messages = get_flashed_messages() %}
            {% if messages %}
              <div class="alert alert-danger">
                {% for message in messages %}
                  <p>{{ message }}</p>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}

          <form id="loginForm" method="POST" action="{{ url_for('autenticacion.loginUsuario') }}">
            <div class="form-group">
              <input
                type="email"
                class="form-control mb-3"
                id="correo_electronico"
                name="correo_electronico"
                autocomplete="email"
                placeholder="Correo electr√≥nico"
                data-translate-placeholder="dpi_login_email_ph"
                required>
            </div>

            <div class="form-group">
              <input
                type="password"
                class="form-control"
                id="password"
                name="password"
                placeholder="Contrase√±a"
                data-translate-placeholder="dpi_login_password_ph"
                required>
              <span
                class="toggle-password"
                onclick="togglePasswordVisibility('password')"
                title="Mostrar/ocultar"
                data-translate="dpi_login_toggle_title"
                data-translate-target="title">üëÅÔ∏è</span>
            </div>

            <!-- Campos ocultos para la ubicaci√≥n -->
            <input type="hidden" id="latitud" name="latitud">
            <input type="hidden" id="longitud" name="longitud">

            <div class="row justify-content-center">
              <div class="col-md-6 mb-4">
                <button type="submit" class="btn btn-primary" data-translate="dpi_login_submit">Ingresar</button>
              </div>
              <div class="col-md-6 mb-2">
                <a href="/registrar_usuario">
                  <button type="button" class="btn btn-secondary" data-translate="dpi_login_register">Registrarse ahora</button>
                </a>
              </div>
            </div>
          </form>

          <form class="mt-4 bts" method="POST" action="{{ url_for('autenticacion.login_google') }}">
            <a class="gplogin social" role="button">
              <i class="fa fa-google-plus"></i>
              <span data-translate="dpi_login_google">Iniciar sesi√≥n con Google</span>
            </a>
          </form>

          <div class="row justify-content-center mt-3">
            <div class="col-md-12 text-center">
              <a
                href="/usuarios_recuperar_contrasena_usuario_sistema"
                class="btn btn-link text-white"
                data-translate="dpi_login_forgot">
                ¬øOlvidaste tu contrase√±a?
              </a>
            </div>
          </div>

        </div>
      </div>

    </div>
  </section>
</div>
<!-- ===== Fin bloque ordenado ===== -->










  
<!-- Modal -->
 <div class="modal fade" id="modalSeleccionCodigoPostal" tabindex="-1" aria-labelledby="modalSeleccionCodigoPostalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" style="color: black;"
            id="modalSeleccionCodigoPostalLabel"
            data-translate="dpi_zip_modal_title">
          Selecciona tu C√≥digo Postal
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Cerrar"
                data-translate="dpi_zip_btn_close_aria"
                data-translate-target="aria-label"></button>
      </div>

      <div class="modal-body">
        <label for="codigoPostalModal" style="color: black;" data-translate="dpi_zip_label">C√≥digo Postal:</label>
        <input type="text" id="codigoPostalModal" class="form-control"
               placeholder="Ingresa tu c√≥digo postal"
               data-translate-placeholder="dpi_zip_placeholder">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                data-translate="dpi_zip_btn_close">Cerrar</button>
        <button type="button" class="btn btn-primary" onclick="guardarCodigoPostal()"
                data-translate="dpi_zip_btn_save">Guardar</button>
      </div>
    </div>
  </div>
</div>





<p id="status">Esperando ubicaci√≥n...</p>

  {% include 'notificaciones/cookies/aceptaCookies.html' %}

  {% include 'layouts/layout_footer.html' %}

 

  
  <!-- Aqu√≠ se agrega el script -->  
  <script>
    
    document.getElementById("loginForm").addEventListener("submit", function (event) {
      event.preventDefault(); // Detener el env√≠o del formulario hasta obtener la ubicaci√≥n
     
      let latitude = localStorage.getItem("latitude");
      let longitude = localStorage.getItem("longitude");
  
      if (latitude && longitude) {
          // Si hay datos almacenados, llenamos los campos ocultos y enviamos el formulario
          document.getElementById("latitud").value = latitude;
          document.getElementById("longitud").value = longitude;
          event.target.submit();
      }  else {
          // Si el navegador no soporta geolocalizaci√≥n
          document.getElementById("status").textContent = "Geolocalizaci√≥n no soportada.";
          event.target.submit(); // Enviar de todos modos
      }
  });
  
    var ambito = localStorage.getItem("dominio");
    let ambito_actual = "<a ' style='text-decoration:none; color:orange;'>" + ambito + "</a>";
    document.getElementById("ambitoActual").innerHTML = ambito_actual;
    function showError(message) {
      // muestra un mensaje de error al usuario
      alert(message);
      // o agrega un elemento HTML con el mensaje de error a la p√°gina
      // por ejemplo, con jQuery:
      // $('body').append('<div class="alert alert-danger">' + message + '</div>');
    }
  
    
      // Obtener el token del localStorage
      var token = localStorage.getItem('access_token');
      var refresh_token = localStorage.getItem('refresh_token');
      var selectorEnvironment = localStorage.getItem('selector');
      account =  localStorage.getItem('cuenta');
     

      if (token) {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const tokenExpirationDate = new Date(payload.exp * 1000);
        const currentDateTime = new Date();
        vencimiento_access_token = currentDateTime.getTime() > tokenExpirationDate.getTime();
      } else {
      // En caso de que no haya un token
      //  console.log("No hay token disponible");
      }  
      //console.log("tokenExpirationDate: ",tokenExpirationDate," currentDateTime: ",currentDateTime," vencimiento: ",vencimiento_access_token)
      
      if (token) { // Verificar si el token existe en el localStorage
        
       
        // Enviar una solicitud a la ruta Flask y pasar el token como parte del cuerpo de la solicitud en formato JSON
        $.ajax({
          type: "POST",
          url: "{{ url_for('autenticacion.loginIndex') }}",
          contentType: "application/json",
          data: JSON.stringify({'token': token,'refresh_token':refresh_token,'selectorEnvironment':selectorEnvironment,'account':account}),
          success: function(response) {
            if (response.redirect) {
              window.location.href = response.redirect;
            } else {
              // handle error
              if (vencimiento_access_token){
                localStorage.removeItem('access_token')
              }
              showError("No se pudo redirigir al usuario se puede haber vencido el token loguee nuevamente");
            }
          },
          error: function(error) {
            // handle error
            showError("Hubo un error en la solicitud AJAX");
          }
        });
      }
   






      
  function togglePasswordVisibility(id) {
    var passwordField = document.getElementById(id);
    var icon = passwordField.nextElementSibling;

    if (passwordField.type === "password") {
      passwordField.type = "text";
      icon.textContent = "üôà";
    } else {
      passwordField.type = "password";
      icon.textContent = "üëÅÔ∏è";
    }
  }



  document.querySelector(".btn-discover")?.addEventListener("click", () => {
  setTimeout(() => document.getElementById("ambitoActual")?.focus({ preventScroll: true }), 400);
});


  </script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dpis/mensajeinicial.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dpis/dpiTruncateTexto.css') }}">
  <script src="{{ url_for('static', filename='js/usuarios/usuarioUbicacion.js') }}"></script>
  <script src="{{ url_for('static', filename='js/logs.js') }}"></script>

  <script src="{{ url_for('static', filename='js/i18n.js') }}"></script>
  
 

{% endblock %}