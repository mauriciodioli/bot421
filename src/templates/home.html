{% extends "layouts/layout.html" %}
{% block content %}

<div class="jumbotron">  



  <div class="splashCarga" id="splashNotificaciones" style="display: none;">
    <div class="splash-contenido">
        <div class="spinner"></div>
      </div>
  </div>
  
<div class="promo-banner">
  <a href="https://s.click.aliexpress.com/e/_c3vGvCVt"
     target="_blank" rel="nofollow sponsored noopener noreferrer">
    <img src="https://ae01.alicdn.com/kf/S49a4d147835d4372b13b5d44f76e4d27e.jpg"
         alt="Promo Reparación">
  </a>
</div>


 <div class="pull-up-80" style="margin-top: -80px; margin-bottom: -40px;">
        {% include 'ambitos/carrucelDominios.html' %}
      </div>

<!-- Lista de dominios (móviles) -->
  <section class="domains" id="domains">
    <div class="card-container">
      <!-- Aquí se insertará los dominios -->
    </div>    
  </section>
<div  id="navBarCaracteristicas-home" style="display: none;"></div>

   <div class="nav-wrapper--sm">
      {% include 'ambitos/navBarCaracteristicas.html' %}
    </div>




<h1 id="ambitoActualHome" style="color: black;" class="ambito-actual ambito-actual--accent" tabindex="0"></h1>
    <div class="home-muestra-publicaciones-centrales">
     
     <!-- Aquí se incrustará la galería de imágenes -->
    </div>
   
</div>






<!-- Modal -->
 <div class="modal fade" id="modalSeleccionCodigoPostal" tabindex="-1" aria-labelledby="modalSeleccionCodigoPostalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" style="color: black;"
            id="modalSeleccionCodigoPostalLabel"
            data-translate="dpi_zip_modal_title">
          Selecciona tu Código Postal
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="Cerrar"
               
                data-translate-target="aria-label"></button>
      </div>

      <div class="modal-body">
        <label for="codigoPostalModal" style="color: black;" data-translate="dpi_zip_label">Código Postal:</label>
        <input type="text" id="codigoPostalModal" class="form-control"
               placeholder="Ingresa tu código postal"
               data-translate-placeholder="dpi_zip_placeholder">
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                data-translate="dpi_zip_btn_close">Cerrar</button>
        <button type="button" class="btn btn-primary" onclick="guardarCodigoPostal()"
                data-translate="dpi_zip_btn_save">Guardar</button>
      </div>
    </div>
  </div>
</div>

{% include 'layouts/layout_footer.html' %}   

{% include 'layouts/layout_bajo.html' %}  
<script>




// Definir la función showError
function showError(message) {
  console.error(message);
  // Aquí puedes agregar el código para mostrar el error al usuario, como una alerta o una notificación en la página.
}
let guardada = localStorage.getItem("date")
access_token = localStorage.getItem("access_token")  
correo_electronico = localStorage.getItem("correo_electronico")  

let codigo_postal = localStorage.getItem('codigoPostal')
if (codigo_postal) {
    // Aquí se almacena la cookie con 'codigoPostal'
    document.cookie = `codigoPostal=${codigo_postal}; path=/; max-age=31536000`; // max-age=31536000 es 1 año
}

// Verificar si el access_token está presente y no ha expirado

if (!access_token || !correo_electronico || tokenExpirado(access_token)) {
  showError("Debe iniciar sesión para acceder a esta página.");
  localStorage.removeItem('access_token');
  localStorage.removeItem('refresh_token');
  // Redirigir al usuario a la página de login u otra página adecuada
  window.location.href = "/";  // Ejemplo: redirigir a la página de inicio de sesión
} else {
  // Token válido, continuar con la lógica de la página home
  console.log("Token válido. Usuario permitido acceder a /home.");

  // Aquí puedes continuar con la lógica de tu página home
  // Por ejemplo, realizar solicitudes AJAX u otras operaciones permitidas para usuarios autenticados
}


// console.log("entra en scriptt en archivo login.html y guarda la token: ",tokenGuardado)//muestra localStorage    
if (!access_token || tokenExpirado(access_token)) {
  // Obtener los tokens desde el diccionario de contexto de Flask
 
  {% if tokens is defined %}
    access_token = "{{ tokens[0] }}";
    const refresh_token = "{{ tokens[1] }}";
    correo_electronico = "{{ tokens[2] }}";
    const expiry_timestamp = "{{ tokens[3] }}";  // Marca de tiempo de expiración
    const roll = "{{ tokens[4] }}";
    const cuenta = "{{ tokens[5] }}";
    const selector = "{{ tokens[6] }}";
    const usuario = "{{ tokens[7] }}";
    const usuario_id = "{{ tokens[8] }}";
    const codigoPostal = "{{ tokens[9] }}";


    // Almacenar los tokens y la marca de tiempo de expiración en el localStorage
    localStorage.setItem("access_token", access_token);
    localStorage.setItem("refresh_token", refresh_token);
    localStorage.setItem("correo_electronico", correo_electronico);
    localStorage.setItem("expiry_timestamp", expiry_timestamp);
    localStorage.setItem("roll",roll);
    localStorage.setItem("cuenta",cuenta);
    localStorage.setItem("selector",selector);
    localStorage.setItem("usuario",usuario);
    localStorage.removeItem('usuario_id');
    localStorage.setItem("usuario_id",usuario_id);
    if (codigoPostal) {  
      localStorage.setItem("codigoPostal", codigoPostal);  
    }
  // Si 'codigoPostal' está presente, almacenarlo en las cookies
 
  {% endif %}
}else {
// Token válido, usarlo para la solicitud AJAX
//document.getElementById("access_token").value = access_token;
}

// Función para verificar si el token ha expirado
function tokenExpirado(token) {
const expiry_timestamp = localStorage.getItem("expiry_timestamp");
if (!expiry_timestamp) {
  return true;  // No se encontró la marca de tiempo de expiración, considerar expirado
}
const now_timestamp = new Date().getTime() / 1000;  // Convertir a segundos
return now_timestamp >= expiry_timestamp;
}
/////////////////////// en esta seccion llama para ver
var token = localStorage.getItem('access_token');
if (tokenExpirado(token)) {
// Almacenar los nuevos tokens en el localStorage

localStorage.setItem("refresh_token", response.refresh_token);
localStorage.setItem("correo_electronico", correo_electronico);
localStorage.setItem("expiry_timestamp", response.expiry_timestamp);

// Usar el nuevo access_token para la solicitud AJAX
document.getElementById("token").value = response.access_token;
console.log("Se ha obtenido un nuevo token exitosamente.");
}
else {
console.log("No se pudo obtener un nuevo token.");
}



///////////////////// en esta parte se llama para el logeo autmatico en el broker////////////////

 
    // Obtener el token del localStorage
   
    var refresh_token = localStorage.getItem('refresh_token');
    correo_electronico = localStorage.getItem('correo_electronico');
    var cuenta = localStorage.getItem("cuenta");
    var usuario = localStorage.getItem("usuario");
    var simuladoOproduccion = localStorage.getItem("selector");
    var accesstoken;
    var refreshtoken;
    var usuario1;
    
    
   /* if (access_token) { // Verificar si el token existe en el localStorage
      // Enviar una solicitud a la ruta Flask y pasar el token como parte del cuerpo de la solicitud en formato JSON
      $.ajax({
        type: "POST",
        url: "{{ url_for('get_login.loginExtAutomatico') }}",
        contentType: "application/json",
        data: JSON.stringify({
                              'rutaDeLogeo':'Home',
                              'access_token': access_token,
                              'refresh_token':refresh_token,
                              'correo_electronico':correo_electronico,
                              'cuenta':cuenta,
                              'usuario':usuario,
                              'simuladoOproduccion':simuladoOproduccion

                            }),
        success: function(response) {
          if (response.redirect) {
            window.location.href = response.redirect;
          } else {
            // handle error
            showError("No se pudo redirigir al usuario se puede haber vencido el token loguee nuevamente");
          }
        },
        error: function(error) {
          // handle error
          showError("Hubo un error en la solicitud AJAX");
        }
      });
    }*/
  

    // Obtener los tokens de localStorage y realizar la solicitud fetch
    function obtenerTokens() {
      accesstoken = localStorage.getItem('access_token');
      correo_electronico = localStorage.getItem('correo_electronico');
      refreshtoken = localStorage.getItem('refresh_token');
      usuario1 = localStorage.getItem('usuario');
      fetch('https://ipapi.co/json/')
        .then(response => response.json())
        .then(data => {
          const ip = data.ip;
          console.log(ip);
          console.log(correo_electronico);
          console.log(usuario1);
          localStorage.setItem('ip', ip);
    
          if (ip) {
            try {
              // Enviar una solicitud a la ruta Flask y pasar el token como parte del cuerpo de la solicitud en formato JSON
              $.ajax({
                type: "POST",
                url: "{{ url_for('media_e_mail.save_ip') }}",
                contentType: "application/json",
                data: JSON.stringify({ 'ip': ip, 'accesstoken': accesstoken, 'correo_electronico': correo_electronico, 'usuario1': usuario1 }),
                success: function (response) {
                  if (response.redirect) {
                    window.location.href = response.redirect;
                  } else {
                    showError("No se pudo redirigir media_e_mail.save_ip");
                  }
                },
                error: function (error) {
                  // handle error
                  showError("Hubo un error en la solicitud AJAX");
                }
              });
            } catch (error) {
              showError("Se produjo un error inesperado");
            }
          }
        })
        .catch(error => console.error(error));
    
    }
    
    // Llamar a la función obtenerTokens
    //obtenerTokens();


   

</script>

<!--se llama para cargar imagenes-->

<!---->  <link rel=   "stylesheet" href=" {{ url_for('static', filename='css/social/publicaciones/muestraPublicacionesEnHome.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/dpis/dpi_dominios.css') }}">
<script src="https://dpia.site/embed.js?v=20251002" data-api="/api/p/" defer></script>
<script src="{{ url_for('static', filename='js/media/muestraPublicacionesEnHome.js') }}"></script>
<script src="{{ url_for('static', filename='js/i18n.js') }}"></script>




<!--<script src="http://127.0.0.1:8100/static/js/embed.js?v=debug" data-api="http://127.0.0.1:8100/api/popup/" defer></script>-->


<script>


cargarPublicaciones('','layout')
</script>
{% endblock%}
