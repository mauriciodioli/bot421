
{% if layout == 'layout'%}
{% extends 'layouts/layout.html' %}
{% endif %}

{% if layout == 'layout_fichas'%}
{% extends 'layouts/layout_fichas.html' %}
{% endif %}

{% if layout == 'layoutConexBroker' %}
{% extends 'layouts/layoutConexBroker.html' %}    
{% endif %}
{% if layout == 'layout_signal' %}
{% extends 'layouts/layout_signal.html' %}    
{% endif %}

{% block title %}Galeria imagenes{% endblock %}
{% block content %}
<div>
   <div class="container_galeria_imagenes">
        <div class="post-card">
            <div class="post-header">
                <img src="static/uploads/user-avatar.jpg" alt="User Avatar" class="avatar">
                <input type="text" placeholder="Crear publicación" class="post-input_creaPublicacion" id="createPostBtn_creaPublicacion">
      
            </div>

            <div class="post-options">
                <div class="option">
                    <img src="static/icons/media-icon.png" alt="Multimedia Icon" class="icon">
                    <span>Contenido multimedia</span>
                </div>
                <div class="option">
                    <img src="static/icons/experience-icon.png" alt="Experience Icon" class="icon">
                    <span>Contribuye con tu experiencia</span>
                </div>
                <div class="option">
                    <img src="static/icons/article-icon.png" alt="Article Icon" class="icon">
                    <span>Escribir artículo</span>
                </div>
            </div>
        </div>
    </div>

  <div class="image-grid">
    {% for imagen in imagenes %}
    <div class="card">
      <div class="card-header">
        <h3>{{ imagen.user}}</h3> <!-- Reemplaza con el nombre real del usuario -->
        <button class="close-card" onclick="cerrarTarjeta(this.parentElement.parentElement)">Cerrar</button>
      </div>
      <div class="card-body">
        <img src="{{ url_for('static', filename=imagen.image_paths) }}" alt="Imagen">
        <button class="close-button-mostrar" onclick="eliminarImagen('{{ imagen.image_paths }}')">X</button>
      </div>
      <div class="card-footer">
        <p>Descripción de la imagen: {{ imagen.descripcion }}</p> <!-- Reemplaza con la descripción real de la imagen -->
      </div>
    </div>
    <div class="container">
      <div class="new-post">
          <input type="text" id="user" placeholder="Your Name">
          <textarea id="content" placeholder="What's on your mind?"></textarea>
          <input type="text" id="media_url" placeholder="Video URL (optional)">
          <button onclick="createPost()">Post</button>
      </div>
      <div class="sort-options">
          <select id="sort-by" onchange="fetchPosts()">
              <option value="timestamp">Most Recent</option>
              <option value="views">Most Viewed</option>
          </select>
      </div>
      <div id="posts"></div>
  </div>
  
  {% endfor %}
  
  </div>
</div>

<!-- Modal for creating a post -->
<div id="createPostModal_creaPublicacion" class="modal_creaPublicacion">
  <div class="modal-content_creaPublicacion">
      <span class="close_creaPublicacion">&times;</span>
      <h2>Crear Publicación</h2>
      <form id="createPostForm_creaPublicacion" enctype="multipart/form-data">
          <textarea name="postText_creaPublicacion" placeholder="Escribe tu publicación" required></textarea>
          
          <!-- Hidden file input -->
          <input type="file" id="fileInput_creaPublicacion" name="mediaFile_creaPublicacion" accept="image/*,video/*" multiple style="display: none;">

          <!-- Button with media icon to trigger file input -->
          <label for="fileInput_creaPublicacion" class="media-icon-button_creaPublicacion">
              <img src="static/icons/media-icon.png" alt="Select File Icon">
              <span>Seleccionar archivo</span>
          </label>

          <!-- Container to display selected images and videos -->
          <div id="mediaContainer_creaPublicacion" class="media-container_creaPublicacion"></div>
          
          <button type="submit">Enviar</button>
      </form>
  </div>
</div>


<!-- Modal for viewing and editing an image -->
<div id="imageModal_creaPublicacion" class="image-modal_creaPublicacion">
  <div class="image-modal-content_creaPublicacion">
    <span class="close-image_creaPublicacion">&times;</span>
    <div class="cropper-container">
      <img id="modalImage_creaPublicacion" src="" alt="Selected Image">
    </div>
    
    <button id="saveCroppedImage">Guardar Imagen</button>
  </div>
</div>







<!-- ... Tu código HTML ... -->
{% include 'layouts/layout_footer.html' %}
<script>





  document.addEventListener('DOMContentLoaded', function() {
    fetchPosts();
});

function fetchPosts() {
    const sortBy = document.getElementById('sort-by').value;
    fetch(`/api/posts?sort_by=${sortBy}`)
        .then(response => response.json())
        .then(posts => {
            const postsContainer = document.getElementById('posts');
            postsContainer.innerHTML = '';
            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'post';
                postElement.innerHTML = `
                    <div class="post-header">
                        <img src="https://via.placeholder.com/40" alt="User Image">
                        <strong>${post.user}</strong>
                        <span>${post.timestamp}</span>
                    </div>
                    <div class="post-body">
                        <p>${post.content}</p>
                        ${post.media_url ? `<video controls src="${post.media_url}"></video>` : ''}
                    </div>
                    <div class="post-footer">
                        <div class="views">Views: ${post.views}</div>
                        <div class="actions">
                            <button class="action">Comment</button>
                            <button class="action">Share</button>
                            <button class="action">Forward</button>
                        </div>
                    </div>
                `;
                postsContainer.appendChild(postElement);
            });
        });
}

function createPost() {
    const user = document.getElementById('user').value;
    const content = document.getElementById('content').value;
    const media_url = document.getElementById('media_url').value;

    if (user && content) {
        fetch('/api/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user, content, media_url })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('user').value = '';
            document.getElementById('content').value = '';
            document.getElementById('media_url').value = '';
            fetchPosts();
        });
    } else {
        alert('Please enter your name and content');
    }
}




















  function eliminarImagen(imageName) {
    // Mostrar un cuadro de confirmación antes de proceder
    var confirmarEliminacion = confirm('¿Estás seguro de que deseas eliminar esta imagen?');

    if (confirmarEliminacion) {
      var accessToken = localStorage.getItem('access_token');
      var randomNumber = Math.round(Math.random() * 1000000);

      $.ajax({
        url: '/eliminarImagen',
        type: 'POST',
        data: {
          randomNumber: randomNumber,
          imageName: imageName,
          // Otros datos si es necesario
        },
        headers: {
          'Authorization': 'Bearer ' + accessToken
        },
        success: function(response) {
          console.log('Imagen eliminada con éxito:', response);
          $('#result').html('Imagen eliminada con éxito. Respuesta del servidor: ' + response);

          // Puedes realizar otras acciones después de eliminar la imagen, como actualizar la interfaz de usuario.
        },
        error: function(error) {
          $('#result').html('Error al eliminar la imagen. Detalles: ' + JSON.stringify(error));
        }
      });
    } else {
      // El usuario canceló la eliminación
      console.log('Eliminación cancelada por el usuario.');
    }
  }

  function cerrarTarjeta(card) {
    card.style.display = 'none';
  }






























  // Get the modal
var modal = document.getElementById("createPostModal_creaPublicacion");

// Get the button that opens the modal
var btn = document.getElementById("createPostBtn_creaPublicacion");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close_creaPublicacion")[0];

// When the user clicks the button, open the modal 
btn.onclick = function() {
  modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
  if (event.target == modal) {
      modal.style.display = "none";
  }
}





document.addEventListener('DOMContentLoaded', function() {
  initializeMediaHandlers();
 
});

function initializeMediaHandlers() {
  var fileInput = document.getElementById('fileInput_creaPublicacion');
  var mediaContainer = document.getElementById('mediaContainer_creaPublicacion');
  var mediaModal = document.getElementById('imageModal_creaPublicacion');
  var modalImage = document.getElementById('modalImage_creaPublicacion');
  var closeMediaModal = document.querySelector('.close-image_creaPublicacion');
  var cropper;

  fileInput.addEventListener('change', function(event) {
    var files = event.target.files;

    for (var i = 0; i < files.length; i++) {
      var file = files[i];
      var reader = new FileReader();

      reader.onload = function(e) {
        var mediaElement;
        if (file.type.startsWith('image/')) {
          mediaElement = document.createElement('img');
          mediaElement.src = e.target.result;
          mediaElement.classList.add('thumbnail_creaPublicacion');
        } else if (file.type.startsWith('video/')) {
          mediaElement = document.createElement('video');
          mediaElement.src = e.target.result;
          mediaElement.controls = true;
          mediaElement.classList.add('thumbnail_creaPublicacion');
        }

        mediaElement.addEventListener('click', function() {
          openMediaModal(e.target.result, file.type);
        });
        mediaContainer.appendChild(mediaElement);
      };

      reader.readAsDataURL(file);
    }
  });

  function openMediaModal(src, type) {
    if (type.startsWith('image/')) {
      modalImage.src = src;
      mediaModal.style.display = 'block';

      // Inicializar Cropper.js
      cropper = new Cropper(modalImage, {
        aspectRatio: 16 / 9, // Ajusta la relación de aspecto según sea necesario
        viewMode: 1,
        autoCropArea: 1,
        cropBoxResizable: true,
        cropBoxMovable: true,
        movable: true,
      });
    } else if (type.startsWith('video/')) {
      modalImage.src = ''; // Clear image when opening video
      modalImage.innerHTML = `<video src="${src}" controls style="max-width: 100%; max-height: 100%;"></video>`;
    }
  }



  function saveCroppedImage() {
    if (cropper) {
      cropper.getCroppedCanvas().toBlob(function(blob) {
        var url = URL.createObjectURL(blob);
        var img = document.createElement('img');
        img.src = url;
        img.classList.add('thumbnail_creaPublicacion');

        // Añadir la imagen recortada al contenedor de medios en el modal de creación
        mediaContainer.appendChild(img);

        // Asegurar que la imagen recortada se puede abrir en el modal
        img.addEventListener('click', function() {
          openMediaModal(url, 'image/');
        });

        // Eliminar la imagen original
        var thumbnails = mediaContainer.getElementsByClassName('thumbnail_creaPublicacion');
        for (var i = 0; i < thumbnails.length; i++) {
          if (thumbnails[i].src === modalImage.src) {
            mediaContainer.removeChild(thumbnails[i]);
            break;
          }
        }

        // Cerrar el modal de edición y eliminar el cropper
        mediaModal.style.display = 'none';
        cropper.destroy();
      });
    }
  }

  closeMediaModal.addEventListener('click', function() {
    mediaModal.style.display = 'none';
    if (cropper) {
      cropper.destroy();
    }
  });

  
  document.getElementById('saveCroppedImage').addEventListener('click', saveCroppedImage);
}









$(document).ready(function() {
  $("#createPostForm_creaPublicacion").on("submit", function(event) {
      event.preventDefault(); // Prevent the default form submission

      var formData = new FormData(this);

      $.ajax({
          url: '/ruta_a_tu_archivo.py', // Reemplaza con la ruta a tu archivo .py
          type: 'POST',
          data: formData,
          processData: false, // Prevent jQuery from automatically transforming the data into a query string
          contentType: false, // Prevent jQuery from setting Content-Type header
          success: function(response) {
              alert("Publicación creada exitosamente.");
              modal.style.display = "none"; // Close the modal on success
          },
          error: function(xhr, status, error) {
              alert("Error al crear la publicación. Inténtalo de nuevo.");
          }
      });
  });
});

</script>

<!-- ... Más código HTML ... -->
















{% endblock %}
