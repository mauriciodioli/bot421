{# ===== Layout dinámico (debe ir antes de todo) ===== #}
{% set base = 'layouts/layout_administracion.html' if layout == 'layout_administracion' else 'layouts/layout.html' %}
{% extends base %}

{% block content %}

{# ===== Mensajes flash ===== #}
{% with messages = get_flashed_messages() %}
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="cart-container">
  <h3 style="color:black;">Lista de Publicaciones</h3>

  <div class="search-container">
    <input type="text" id="consulta_publicaciones_data" name="consulta_publicaciones_data" placeholder="Buscar por ID o Usuario">
    <button id="search_button" type="button">
      <i class="fa fa-search"></i>
    </button>
  </div>

  <div class="table-container">
    <table class="consulta-table">
      <tbody>
        {% for consulta in data %}
        <tr data-precio="{{ consulta.precio_venta }}" data-id="{{ consulta.id }}">
          <td>
            {% if consulta.imagen_url %}
              <img src="{{ consulta.imagen_url }}" alt="Imagen del producto" class="product-image">
            {% else %}
              <img src="default.jpg" alt="Producto sin imagen" class="product-image">
            {% endif %}
          </td>

          <td class="text">{{ consulta.nombre_producto }}</td>

          <td class="price">
            <span class="unit-price">{{ consulta.precio_venta }}</span>
          </td>

          <td>
            <input type="number" id="quantity-{{ consulta.id }}" name="quantity" class="quantity-input" value="1" min="1">
          </td>

          <td>
            <input type="checkbox"
                   class="estado-checkbox"
                   onchange="agregarListado({{ consulta.id }}, this)"
                   {{ 'checked' if consulta.precio_venta == 'entregado' else '' }}>
          </td>

          <td>
            <button class="remove-button"
                    data-consulta-id="{{ consulta.id }}"
                    data-user-id="{{ consulta.user_id }}"
                    style="display:none;">
              Eliminar
            </button>
          </td>

          <td>
            <button class="btn btn-success detalleProducto"
                    data-consulta-id="{{ consulta.id }}"
                    data-user-id="{{ consulta.user_id }}">
              Detalle
            </button>
          </td>

          {# === NUEVA COLUMNA: Códigos postales === #}
          <td>
            <button class="btn btn-sm btn-primary btn-cp"
                    data-consulta-id="{{ consulta.id }}"
                    data-nombre-producto="{{ consulta.nombre_producto|e }}">
            Códigos postales
            </button>

          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# Si querés mantener el contenedor (aunque no lo uses) #}
  <div class="cart-summary-container"></div>

</div>

{# ===== Modal Detalle (lo dejé tal cual) ===== #}
<div class="modal" id="detalleModal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="cerrarModal()">&times;</span>
    <h2 style="color:yellowgreen">Detalle del Producto</h2>
    <p><span id="productoNombre"></span></p>
    <p><strong>Descripción:</strong> <span id="productoDescripcion"></span></p>
    <p><span id="productoTexto"></span></p>
    <p><span id="productoCorreo"></span></p>
    <p><strong>Fecha de Creación:</strong> <span id="productoFecha"></span></p>
    <p><strong>Usuario ID:</strong> <span style="color:rgb(255, 80, 80)" id="productoUserId"></span></p>
  </div>
</div>

{# ===== NUEVO Modal Códigos postales ===== #}
<div class="modal fade" id="codigosPostalesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content" style="color:#000;">
      <div class="modal-header">
        <h5 class="modal-title">Códigos postales · <span id="cp-modal-titulo"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <h6>Actualmente visible en:</h6>
        <ul id="cp-lista-actual" class="list-group mb-3"></ul>

        <div class="d-flex gap-2 align-items-end">
          <div class="flex-grow-1">
            <label class="form-label">Agregar código postal</label>
            <input type="text" id="cp-input" class="form-control" placeholder="Ej: 1407, CABA, Buenos Aires">
          </div>
          <button class="btn btn-success" id="cp-btn-agregar">Agregar</button>
        </div>

        <div class="form-text mt-2">
          Tip: podés filtrar con el teclado en el select (id, código, ciudad).
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{% include 'layouts/layout_footer.html' %}

{# ===== CSS de la vista ===== #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/social/publicaciones/consultasPublicaciones.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/social/publicaciones/consultasPublicacionesAdmin.css') }}">

{# ===== JS base de la vista ===== #}
<script src="{{ url_for('static', filename='js/media/publicaciones/consultaPublicacionesAdmin.js') }}"></script>



{% endblock %}
