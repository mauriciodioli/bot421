{% if layout == 'layout'%}
{% extends 'layouts/layout.html' %}
{% endif %}

{% if layout == 'layout_fichas'%}
{% extends 'layouts/layout_fichas.html' %}
{% endif %}

{% if layout == 'layout_dpi'%}
{% extends 'layouts/layout_dpi.html' %}
{% endif %}

{% if layout == 'layoutConexBroker' %}
{% extends 'layouts/layoutConexBroker.html' %}    
{% endif %}
{% if layout == 'layout_signal' %}
{% extends 'layouts/layout_signal.html' %}    
{% endif %}
{% if layout == 'layout_muestra_imagenes_dpi' %}
{% extends 'layouts/layout_muestra_imagenes_dpi.html' %} 
{% endif %}
{% if layout == 'layout_detalle_productos' %}
{% extends 'layouts/layout_detalle_productos.html' %} 
{% endif %}

{% block title %}Publicacion desplegada{% endblock %}
{% block content %}
<div class="publicacion-detalle">
    <div class="splashCarga" id="splashNotificaciones" style="display: none;">
        <div class="splash-contenido">
            <div class="spinner"></div>
          </div>
      </div>
    
















<div class="grid-malla" id="contenedor-publicacion">


    <!-- Columna izquierda -->
  <div class="celda">
   
  <!-- Fila 2: Texto superior -->
          <div class="fila texto-superior" onclick="cargarDatosPublicacion()" style="cursor: pointer;">
                <p data-translate="discover_projects">Discover more projects by clicking here</p>
          </div>

    <!-- Fila 4: Imagen o video principal -->
                <div id="principal-media" class="fila imagen-principal-muestra-despliegue-publicacion-home">
                    <input type="hidden" name="publicacion_id" value="{{ post.publicacion_id }}" />

                    {% if post.videos %}
                        <!-- Mostrar el primer video si está disponible -->
                        <img src="/static/img/video-preview.jpg"
                            alt="Vista previa del video"
                            style="cursor: pointer;"
                            onclick="agrandarImagenVideoPublicacion('video', `{% if 'http' in post.videos[0].filepath %}{{ post.videos[0].filepath }}{% else %}{{ url_for('static', filename=post.videos[0].filepath) }}{% endif %}`)" />
                    
                    {% elif post.imagenes %}
                        <!-- Mostrar la primera imagen si no hay videos -->
                        <img id="main-image"
                            src="{% if 'http' in post.imagenes[0].filepath %}{{ post.imagenes[0].filepath }}{% else %}{{ url_for('static', filename=post.imagenes[0].filepath) }}{% endif %}"
                            alt="{{ post.imagenes[0].title }}"
                            style="cursor: pointer;"
                            onclick="agrandarImagenVideoPublicacion('imagen', this.src)" />
                    
                    {% else %}
                        <p>No hay imágenes ni videos disponibles.</p>
                    {% endif %}
                </div>


  </div>

   <!-- columana derecha -->
  <div class="celda">
    
            <!-- Fila 1: Título y fecha -->
                <div class="fila titulo-fecha">
                    <h1>{{ post.titulo }}</h1>

                    <!-- Estrellas dinámicas -->
                    <div class="fila rating-estrellas">
                        {{ estrellas_html | safe }}
                    </div>

                  <p>{{ post.fecha_creacion.strftime('%Y-%m-%d') }}</p>

                </div>

            {% if post.precio %}
                <!-- Fila de Precios y Descuento -->
                <div class="fila precios-publicacion">
                    {% if post.precio_original and post.precio_original > post.precio %}
                    
                        <p class="precio-original">{{ post.simbolo }} {{ post.precio_original }}</p>
                        <p class="precio-descuento text-success fw-bold">{{ post.simbolo }} {{ post.precio }}</p>
                        {% if post.descuento %}
                            <div class="descuento-badge">{{ post.descuento }}</div>
                        {% endif %}
                    {% else %}
                        <p class="precio-descuento text-success fw-bold">{{ post.simbolo }} {{ post.precio }}</p>
                    {% endif %}
                </div>
            {% endif %}

          
        <!-- Fila 3: Información adicional -->
            <div class="fila informacion-adicional">
                <p class="correo-electronico-publicacion-despliegue-home">{{ post.correo_electronico }}</p>
                <p class="ambito-publicacion-despliegue-home"><strong>Ámbito:</strong> {{ post.ambito }}</p>
              <p class="texto-publicacion-despliegue-home destacado-parrafo">
                    {{ post.texto | safe }}
              </p>

            </div>

                <!-- Botón Afiliado -->
            {% if post.afiliado_link %}
                <a href="{{ post.afiliado_link }}" target="_blank" class="btn btn-danger" data-translate="comprarAli">
                    Comprar en AliExpress
                </a>
            {% endif %}


            <!------------------------------------------------------------------------------->
            <!------------------------------------------------------------------------------->
            <!------------------------------------------------------------------------------->
            {% if post.botonCompra %}

                    <div class="fila boton-compra">
                        <form id="sistemaDePagos_get_ofertas_suscripciones" method="POST" action="/productosComerciales_pedidos_alta_carrito/" style="display: flex; align-items: center; gap: 10px;">
                            <input type="hidden" id="ambito_btn_carrito" name="ambito_btn_carrito" value="{{ post.ambito }}">
                            <input type="hidden" id="titulo_btn_carrito" name="titulo_btn_carrito" value="{{ post.titulo }}" >
                            <input type="hidden" id="publicacion_id_btn_carrito" name="publicacion_id_btn_carrito" value="{{ post.publicacion_id }}" >
                            <input type="hidden" id="texto_btn_carrito" name="texto_btn_carrito" value="{{post.texto}}" >
                            <input type="hidden" id="precio_btn_carrito" name="precio_btn_carrito" value="{{post.precio}}" >
                            <input type="hidden" id="precio_btn_PagoOnline" name="precio_btn_PagoOnline" value="{{post.pagoOnline}}" >
                            <input type="hidden" id="access_token_btn_carrito1" name="access_token_btn_carrito1">
                            <input type="hidden" id="correo_electronico_btn_carrito" name="correo_electronico_btn_carrito">   
                        
                            <!-- Campo para la URL de la primera imagen -->
                            {% if post.imagenes and post.imagenes[0].filepath %}
                            <input type="hidden" id="imagen_btn_carrito" name="imagen_btn_carrito" 
                                value="{% if 'http' in post.imagenes[0].filepath %}{{ post.imagenes[0].filepath }}{% else %}{{ url_for('static', filename=post.imagenes[0].filepath) }}{% endif %}">
                            {% endif %}


                          <!-- Combo para elegir cantidad -->
                        <form id="form-agregar">
                        <div class="compra-responsive">
                            <label for="cantidadCompra" data-translate="quantity_label">Cantidad:</label>
                            <input type="number" id="cantidadCompra" name="cantidadCompra" value="1" min="1" step="1" aria-label="quantity_label">
                            <button type="submit" id="boton-agregar" data-translate="add_button">Agregar</button>
                        </div>

                        </form>

                        

                            </form>
                    </div>
                

            {% endif %}


  </div>





<!-- Tabs con i18n -->
<div class="celda full-width">
  <div class="tabs">
    <input type="radio" id="tab1" name="tab-control" checked>
    <input type="radio" id="tab2" name="tab-control">
    <input type="radio" id="tab3" name="tab-control">
    <input type="radio" id="tab4" name="tab-control"> <!-- Nueva pestaña -->

    <ul>
      <li><label for="tab1" role="button"><span data-translate="tab_description">Descripción</span></label></li>
      <li><label for="tab2" role="button"><span data-translate="tab_details">Detalles</span></label></li>
      <li><label for="tab3" role="button"><span data-translate="tab_shipping">Envío</span></label></li>
      <li><label for="tab4" role="button"><span data-translate="tab_returns">Devoluciones</span></label></li>
    </ul>

    <div class="slider"><div class="indicator"></div></div>

    <div class="content">
      <section>
        <h2 data-translate="tab_description">Descripción</h2>
        <p>{{ post.descripcion | safe }}</p>
      </section>
      <section>
        <h2 data-translate="tab_details">Detalles</h2>
        <p data-translate="details_text">Aquí podrías mostrar características técnicas del producto.</p>
      </section>
      <section>
        <h2 data-translate="tab_shipping">Envío</h2>
        <p data-translate="shipping_text">Información de tiempos, zonas y costos de envío.</p>
      </section>
      <section>
        <h2 data-translate="tab_returns">Devoluciones</h2>
        <p data-translate="returns_text">Podés devolver tu compra dentro de los 15 días posteriores a recibirla, sin preguntas. Reembolso del 100% o cambio de producto.</p>
      </section>
    </div>
  </div>
</div>






    <!-- Galería de imágenes y videos -->
        <div class="celda full-width">
          
                <!-- Fila 5: Galería de imágenes y videos -->
                  <div class="fila imagenes-videos-muestra-despliegue-publicacion-home">
                      <div class="imagenes-muestra-despliegue-publicacion-home grid-layout">
                          {% if post.imagenes or post.videos %}
                              {% for media in post.imagenes + post.videos if media.imagen or (media.filepath and (media.filepath.endswith('.jpg') or media.filepath.endswith('.png') or media.filepath.endswith('.mp4'))) %}

                                  <div class="imagen-muestra-despliegue-publicacion-home">
                                      {% if media.filepath.endswith('.mp4') %}
                                          <video 
                                              id="videoPlayer"
                                              class="media-adaptada" 
                                              onclick="replaceMainMedia('{% if 'http' in media.filepath %}{{ media.filepath }}{% else %}{{ url_for('static', filename=media.filepath) }}{% endif %}', 'video')" 
                                              onmouseover="this.play()" 
                                              onmouseout="this.pause(); this.currentTime=0;" 
                                              muted 
                                              loop
                                              playsinline>
                                              <source src="{% if 'http' in media.filepath %}{{ media.filepath }}{% else %}{{ url_for('static', filename=media.filepath) }}{% endif %}" type="video/mp4">
                                              Tu navegador no soporta el formato de video.
                                          </video>
                                      {% else %}
                                          <img 
                                              class="media-adaptada" 
                                              src="{% if 'http' in media.filepath %}{{ media.filepath }}{% else %}{{ url_for('static', filename=media.filepath) }}{% endif %}" 
                                              alt="{{ media.title }}" 
                                              onclick="replaceMainMedia(this.src, 'image')" />
                                      {% endif %}
                                  </div>
                              {% endfor %}
                          {% endif %}
                      </div>
                  </div>



        </div>



     


        



                <div id="contenedor-reseñas" class="testimonials"></div>
                    <div id="mensaje-sin-reseñas" style="display:none;margin-top:10px;">
                        <p data-translate="no_reviews_msg">Sé el primero en dejar una reseña sobre este producto.</p></div>
                        <div class="formulario-reseña">
                            <form id="form-reseña">
                                <input type="text" id="nombre-reseña"  data-translate-placeholder="review_name_ph" placeholder="Tu nombre" aria-label="review_name_ph" required>

                                <textarea id="comentario-reseña" data-translate-placeholder="review_comment_ph" placeholder="Tu comentario..." aria-label="review_comment_ph" required></textarea>
                                <button type="submit" data-translate="submit_review">Enviar reseña</button>
                            </form>
                </div>






 </div>  


<!-- Botón WhatsApp (oculto por defecto) -->
<a id="wa-link"
   class="whatsapp-float"
   href="#"
   target="_blank"
   rel="noopener"
   data-msg="Hola, vi tu publicación en dpia.site y me interesa."
   style="display:none">
  <img src="https://cdn-icons-png.flaticon.com/512/733/733585.png" alt="WhatsApp">
</a>









<div id="media-modal" class="media-modal" onclick="cerrarModal()">
  <span class="media-close" onclick="cerrarModal()">×</span>
  <img id="media-modal-img" class="media-modal-content" style="display:none;">
  <video id="media-modal-video" class="media-modal-content" controls style="display:none;"></video>
  <iframe id="media-modal-iframe" class="media-modal-content" frameborder="0" allowfullscreen style="display:none;"></iframe>
</div>





</div>

{% include 'layouts/layout_footer.html' %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/social/publicaciones/muestraPublicacionesEnAmbitos.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/social/publicaciones/muestraPublicacionesEnHomeAgrandaImagenes.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/social/publicaciones/reseniaMuestraPublicEnHome/reseniaMuestraPublicEnHome.css') }}">

<script src="{{ url_for('static', filename='js/i18n.js') }}"></script>
<script src="{{ url_for('static', filename='js/media/muestraPublicacionesEnAmbito.js') }}"></script>
<script src="{{ url_for('static', filename='js/media/muestraPublicacionesEnAmbitoAgrandaImagenes.js') }}"></script>
<script src="{{ url_for('static', filename='js/productosComerciales/pedidos/carritoCompras.js') }}"></script>
<script src="{{ url_for('static', filename='js/media/publicaciones/reseniaMuestraPublicEnHome/reseniaMuestraPublicEnHome.js') }}"></script>


<script>

    // Almacenar los valores en variables globales
  // Lee valores del DOM/Jinja
  const publicacionIdEl = document.querySelector('input[name="publicacion_id"]');
  const publicacionId   = publicacionIdEl?.value?.trim() || '';
  const userId          = '{{ post.user_id }}';
  const ambito          = '{{ post.ambito }}';
  const layout          = '{{ layout }}';
  const contactoWP = '{{ post.contactoWP }}';

  // Mini i18n solo para el mensaje
  const translation = {
    es: { wa_msg: "Hola, vi tu publicación en dpia.site y me interesa." },
    in: { wa_msg: "Hi, I saw your post on dpia.site and I'm interested." },
    pt: { wa_msg: "Olá, vi sua publicação no dpia.site e me interessei." },
    pl: { wa_msg: "Cześć, zobaczyłem Twoją publikację na dpia.site i jestem zainteresowany." },
    it: { wa_msg: "Ciao, ho visto la tua pubblicazione su dpia.site e sono interessato." },
    fr: { wa_msg: "Salut, j’ai vu ta publication sur dpia.site et je suis intéressé." },
    de: { wa_msg: "Hallo, ich habe deinen Beitrag auf dpia.site gesehen und bin interessiert." },
  };

  function currentLan() {
    let lang =
      (document.cookie.match(/(?:^|;\s*)language=([^;]+)/)?.[1]) ||
      localStorage.getItem('language') ||
      (navigator.language || 'es').split('-')[0];
    if (lang === 'en') lang = 'in';        // tu convención
    return translation[lang] ? lang : 'es';
  }

  // opcional: fallback desde localStorage por usuario
  const LS_KEY = `numTelefono:${localStorage.getItem('usuario_id')||'global'}`;

  (function () {
    const a = document.getElementById('wa-link');
    if (!a) return;

    const REG_E164 = /^\+[1-9]\d{7,14}$/;

    // Número: backend > localStorage > vacío
    const raw = ((contactoWP || '').trim()) || ((localStorage.getItem(LS_KEY) || '').trim());
    const num = /^(None|null|undefined)$/i.test(raw) ? '' : raw;

    if (!REG_E164.test(num)) {
      a.style.display = 'none';
      a.removeAttribute('href');
      return;
    }
    a.style.display = '';

    function msgNow() {
      const lang = currentLan();
      return translation[lang]?.wa_msg
          || a.dataset.msg
          || 'Hola, vi tu publicación en dpia.site y me interesa.';
    }

    // Recalcula en el idioma actual justo antes de navegar
    a.addEventListener('click', function () {
      const digits = num.replace(/\D/g, '');
      const msg = msgNow();
      a.href = `https://wa.me/${digits}?text=${encodeURIComponent(msg)}`;
    });
  })();




  if (publicacionId) {
    // Cookie para todo el sitio, 30 días. Sobre-escribe si ya existe con mismo nombre+path+dominio
    setCookie('publicacion_id', publicacionId, { days: 30, path: '/', domain: cookieDomain(), secure: location.protocol === 'https:' });
    setCookie('dominio', ambito, { days: 30, path: '/', domain: cookieDomain(), secure: location.protocol === 'https:' });
  }

  // También en localStorage (si querés)
  localStorage.setItem('publicacion_id', publicacionId);
  localStorage.setItem('dominio', ambito); // siempre pisa la anterior

  // Helpers
  function setCookie(name, value, { days = 30, path = '/', domain, secure = false, sameSite = 'Lax' } = {}) {
    let cookie = encodeURIComponent(name) + '=' + encodeURIComponent(String(value));

    if (days) {
      const expires = new Date(Date.now() + days * 864e5).toUTCString();
      cookie += '; Expires=' + expires;
      cookie += '; Max-Age=' + (days * 86400);
    }
    cookie += '; Path=' + path;
    if (domain) cookie += '; Domain=' + domain;
    cookie += '; SameSite=' + sameSite;
    if (secure) cookie += '; Secure';

    document.cookie = cookie;
  }

  function cookieDomain() {
    // No setear domain en localhost/IP (rompe la cookie)
    const host = location.hostname;
    if (host === 'localhost' || /^\d{1,3}(\.\d{1,3}){3}$/.test(host)) return undefined;

    // Para dpia.site y subdominios -> ".dpia.site"
    const parts = host.split('.');
    if (parts.length >= 2) return '.' + parts.slice(-2).join('.');
    return undefined;
  }
    
    function replaceMainMedia(src, type) {
    var container = document.getElementById('principal-media');

    if (type === 'image') {
        container.innerHTML = `
            <img id="main-image"
                 class="media-principal-redondeada"
                 style="cursor: pointer;"
                 onclick="agrandarImagenVideoPublicacion('imagen', this.src)"
                 src="${src}"
                 alt="Imagen seleccionada" />
        `;
    } else if (type === 'video') {
        container.innerHTML = `
            <video controls
                   id="main-video"
                   style="cursor: pointer;"
                   onclick="agrandarImagenVideoPublicacion('video', this.querySelector('source').src)">
                <source src="${src}" type="video/mp4">
                Tu navegador no soporta el formato de video.
            </video>
        `;
    }

    // Desplazar suavemente hacia el contenedor de la imagen principal
    container.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Calcular la distancia adicional a desplazar para dejar espacio para el texto
    var offset = container.getBoundingClientRect().top - 230;
    window.scrollBy(0, offset);
}


    

    function abrirPublicacionEnAmbitos(publicacionId, userId, ambito,layout) {
        mostrarPublicacionesEnAmbitos(publicacionId, userId, ambito,layout);
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (!localStorage.getItem('access_token')) {
            const botonCompra = document.querySelector('.fila.boton-compra');
            if (botonCompra) {
                botonCompra.style.display = 'none';
            }
        }
    });


    cargarReseñas();






</script>

{% endblock %}
