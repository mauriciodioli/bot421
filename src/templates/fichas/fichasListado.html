{% with messages = get_flashed_messages()%}
{% if messages %}
{% for message in messages%}  
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{message}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
{% endfor %}
{% endif %}
{% endwith %}

{% if layout == 'layout'%}
    {% extends 'layouts/layout.html' %}
{% endif %}

{% if layout == 'layout_fichas'%}
    {% extends 'layouts/layout_fichas.html' %}
{% endif %}

{% if layout == 'layoutConexBroker' %}
   {% extends 'layouts/layoutConexBroker.html' %}    
{% endif %}



{% block content%}

<div class = 'container p-4'>
    <div class="container p-4 text-center">
        <button type="button" class="btn btn-success mx-2" data-bs-toggle="modal" data-bs-target="#IngresaValorFicha"><strong>RECIBIR</strong></button>

    </div>
                    
    <table class="table table-dark table-striped"  id="tablaDatos">
        <thead>           
            <tr>
                <th scope="col">Ficha</th>               
                <th scope="col">Inicial</th>
                <th scope="col">Capitalizacion</th>
                <th scope="col">Estado</th>                     
                <th scope="col">Operaciones</th>
            </tr>            
        </thead>
        <tbody>
            {% for fichas in datos %}
                <tr>
                    <th scope="row">{{fichas.id}}</th>                      
                    <td>{{ fichas.ficha.monto_efectivo }}</td>
                    <td>{{ fichas.ficha.interes }}%</td>
                    <td>{{fichas.estado_traza }}</td>                                                       
                    <td class="d-flex"> 
           
                       
                             <button type="button" class="btn btn-primary mx-2" data-bs-toggle="modal" data-bs-target="#tokenFichaModal" data-ficha-llave="{{ fichas.random_number }}" data-ficha-monto="{{ fichas.monto_efectivo }}" onclick="setFichaDataToken(this.getAttribute('data-ficha-llave'),this.getAttribute('data-ficha-monto'))"><strong>Asignar</strong></button>
                            <button type="button" class="btn btn-danger mx-2" data-bs-toggle="modal" data-bs-target="#eliminarFichaModal"  data-ficha-id="{{ fichas.id }}" onclick="setFichaData( this.getAttribute('data-ficha-id'))">Reportar</button>
                        </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>


    <div class="modal fade" id="IngresaValorFicha" tabindex="-1" aria-labelledby="IngresaValorFichaModalLabel" aria-hidden="true">
        <div class="modal-dialog ">
            <div class="modal-content border shadow">
                <div class="modal-header">
                </div>
                
                <form id="tomarFicha" action="/fichas-tomar" method="POST">
                    <div class="modal-body">
                        <h6 style="color: blue; margin-bottom: 10px;">INGRESAR TOKEN</h6>
                        <input type="text" id="tokenInput" class="form-control" name="tokenInput" placeholder="Ingresa tu token">
                        <input type="hidden" id="access_token_forma" name="access_token_forma" >
                        <input type="hidden" id="layoutOrigen" name="layoutOrigen" value="layout">
                        <h2 class="modal-title text-center" id="valorllave" style="color: green;  100px; text-align: center;"></h2>
                    
                   
                    </div>
                    <div class="modal-footer">                  
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"  id="aceptarBtn">Aceptar</button>
                    </div>
                </form>    
            </div>
        </div>
    </div>

    <script>
       
        document.addEventListener('DOMContentLoaded', function() {
            var IngresaValorFicha = document.getElementById('IngresaValorFicha');
            IngresaValorFicha.addEventListener('click', function() {
                document.getElementById('tokenInput').value = '';
                document.getElementById('valorllave').textContent = '';
            });
        
            var aceptarBtn = document.getElementById('aceptarBtn');
            var tomarFichaForm = document.getElementById('tomarFicha');
            
            aceptarBtn.addEventListener('click', function() {
                // Obtener el valor del token ingresado
                var tokenInputValue = document.getElementById('tokenInput').value;
        
                // Verificar si el valor es un número y no está vacío
                if (!isNaN(tokenInputValue) && tokenInputValue.trim() !== '') {
                    var tokenForm = localStorage.getItem('access_token');
                    var layoutOrigen = "{{ layout }}";
                    document.getElementById('layoutOrigen').value = layoutOrigen;
                    document.getElementById('access_token_forma').value = tokenForm;
        
                    // Envía el formulario
                    tomarFichaForm.submit();
                } else {
                    // Muestra un mensaje de error o toma la acción que desees
                    alert('Ingresa un número válido en el campo del token.');
                }
            });
        });
        









    </script>
        

</div>
{%endblock%}
 